options "-symbexec-v2"

struct Node {
  var next: Node;
}

procedure lookup_heap_1(x: Node, y: Node)
  requires acc(x) &*& x.next == null
  ensures acc(x) &*& acc(y) &*& x.next == y
{
 y := x.next;
}

procedure lookup_heap_2(x: Node, y: Node)
  requires acc(x) &*& x.next == null
  ensures acc(x) &*& x.next == y
{
 y := x.next;
}

procedure lookup_heap_3(x: Node) returns (y: Node)
  requires acc(x) &*& x.next == null
  ensures acc(x) &*& acc(y) &*& x.next == y
{
 y := x.next;
}

procedure lookup_heap_assign(x: Node) returns (y: Node)
  requires acc(x) &*& x.next == null
  ensures acc(x) &*& acc(y) &*& x.next == y
{
 y := new Node();
 x.next := y;
}

procedure assign_heap(x: Node)
  requires acc(x) &*& x.next == null
  ensures acc(x) &*& x.next == x
{
  x.next := x;
  x.next := null;
  x.next := x;
}

procedure assign_heap2(x: Node, y: Node)
  requires acc(x) &*& x.next == null &*& acc(y) &*& y.next == x
  ensures acc(x) &*& x.next == x &*& acc(y) &*& y.next == null
{
  x.next := x;
  x.next := null;
  y.next := null;
  x.next := x;
}

procedure assign_heap3(x: Node, y: Node)
  requires acc(x) &*& x.next == null &*& acc(y) &*& y == x
  ensures acc(x) &*& x.next == x
{
  y.next := x;
}

procedure spatial_neq1(x: Node, y: Node)
  requires acc(x) &*& acc(y)
  ensures acc(x) &*& acc(y) &*& x != y
{}

// Bugs
/* fails at eval read catch all possibly due to x.next.next */
/*
procedure assign_heap4(x: Node, y: Node)
  requires acc(x) &*& acc(y) &*& x.next == y &*& x.next.next == null
  ensures acc(x) &*& acc(x) &*& x.next == y &*& y.next == x
{
  y.next := x;
}

procedure assign_heap4(x: Node, y: Node)
  requires acc(x) &*& x.next == y &*& acc(y) &*& y.next = null
  ensures acc(x) &*& x.next == y &*& acc(y) &*& y.next == x
{
  x.next.next := x;
}
*/
